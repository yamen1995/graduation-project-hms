<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- redesign res.partner form for HMS -->
<record id="res_partner_form_hms" model="ir.ui.view">
    <field name="name">res.partner.form.hms</field>
    <field name="model">res.partner</field>
    <field name="arch" type="xml">
        <form string="Patient / Insurance" class="hms-contact-form">

        <sheet>
        <div name="button_box" class="oe_button_box">
            <button 
                name="action_open_medical_wizard"
                string="Create Medical Record"
                type="object"
                class="btn-primary"
                icon="fa-medkit"
                groups="hms.group_hms_receptionist,base.group_system"
                invisible="show_create_medical_record == False"
                context="{'new_md': True}"/>

            <button 
                name="action_grant_portal_access"
                string="Grant Portal Access"
                type="object"
                class="btn-primary"
                icon="fa-unlock"
                groups="hms.group_hms_receptionist,base.group_system"/>

            <button 
                name="action_schedule_appointment"
                string="Schedule Appointment"
                type="object"
                class="btn-primary"
                icon="fa-calendar"
                groups="hms.group_hms_receptionist,base.group_system"/>

            <button 
                name="action_start_hospital_visit"
                string="Start Hospital Visit"
                type="object"
                class="btn-primary"
                icon="fa-hospital-o"
                groups="hms.group_hms_receptionist,base.group_system"
                invisible="not medical_record_id"/>
        </div>
            <!-- Header with medical theme -->
            <div class="hms-header">
                <div class="hms-header-bg">
                    <div class="hms-header-content">


                            <!-- Patient avatar and info -->
                            <div class="hms-patient-profile">
                                <field name="image_1920" widget="image" class="oe_avatar hms-patient-avatar" options="{'preview_image': 'avatar_128'}"/>
                                
                                <div class="hms-patient-info">
                                    <!-- Title -->
                                    <div class="oe_title">
                                        <h1 class="hms-patient-name">
                                            <field name="name" class="text-break" placeholder="Full Name" required="1"/>
                                        </h1>
                                    </div>
                                    
                                    <div class="hms-patient-status">

                                        <field name="is_patient" class="hms-status-badge" label="active" invisible='1' />

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main content area -->
                <div class="hms-form-content">
                    <!-- Identity + Contact -->
                    <div class="hms-form-section">
                        <h2 class="hms-section-title">Personal Information</h2>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="hms-info-card">
                                    <h3 class="hms-card-title">Identity</h3>
                                    <field name="birthdate" class="mb-3" placeholder="Birthdate" widget="date"/>
                                    <field name="gender" class="mb-3" placeholder="Gender"/>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="hms-info-card">
                                    <h3 class="hms-card-title">Contact Information</h3>
                                    <field name="phone" widget="phone" class="mb-3" placeholder="Phone"/>
                                    <field name="email" widget="email" class="mb-3" placeholder="Email"/>
                                    <field name="website" class="mb-3" placeholder="Website"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="hms-form-section">
                        <h2 class="hms-section-title">Address Information</h2>
                        <div class="hms-info-card">
                            <div class="row">
                                <div class="col-12 col-md-6">
                                    <field name="street" class="mb-3" placeholder="Street"/>
                                    <field name="street2" class="mb-3" placeholder="Street 2"/>
                                    <field name="city" class="mb-3" placeholder="City"/>
                                </div>
                                <div class="col-12 col-md-6">
                                    <field name="state_id" options="{'no_open': True, 'no_quick_create': True}" class="mb-3" placeholder="State"/>
                                    <field name="zip" class="mb-3" placeholder="ZIP"/>
                                    <field name="country_id" options="{'no_open': True, 'no_create': True}" class="mb-3" placeholder="Country"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <notebook class="hms-notebook">
                        <!-- Medical Info -->
                        <page string="Medical Information" invisible="is_patient == False" class="hms-tab-page">
                            <div class="hms-form-section">
                                <div class="row">
                                    <div class="col-12 col-md-6">
                                        <div class="hms-info-card">
                                            <h3 class="hms-card-title">Insurance Details</h3>
                                            <field name="medical_record_id" invisible="1"/>
                                            <field name="insurance_id" string="Insurance Company" class="mb-3" placeholder="Insurance" options="{'no_create': True, 'no_open': True}"/>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-6">
                                        <div class="hms-info-card">
                                            <h3 class="hms-card-title">Emergency Contact</h3>
                                            <field name="emergency_contact_id" class="mb-3" placeholder="Emergency Contact"/>
                                            <field name="emergency_phone" widget="phone" class="mb-3" placeholder="Emergency Phone"/>
                                            <field name="emergency_relation" class="mb-3" placeholder="Emergency Relation"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </page>


                        <!-- Notes -->
                        <page string="Notes" class="hms-tab-page">
                            <div class="hms-form-section">
                                <div class="hms-info-card">
                                    <h3 class="hms-card-title">Internal Notes</h3>
                                    <field name="comment" placeholder="Add internal notes here..." class="hms-notes-field"/>
                                </div>
                            </div>
                        </page>
                    </notebook>
                </div>
            </sheet>
        </form>
    </field>
</record>


    <record id="view_res_partner_kanban_hms" model="ir.ui.view">
        <field name="name">res.partner.kanban.hms</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <kanban class="hms-kanban-board" >
                <field name="name"/>
                <field name="is_patient"/>
                <field name="is_insurance_company"/>
                <field name="image_1920"/>
                <field name="birthdate"/>
                <field name="gender"/>
                <field name="phone"/>
                <field name="email"/>
                <field name="medical_record_id"/>
                <field name="show_create_medical_record"/>
                <templates>
                    <t t-name="card">
                        <div class="hms-patient-card">
                            <!-- Card Header -->
                            <div class="hms-patient-header">
<img t-att-src="record.image_1920 and '/web/image/res.partner/' + record.id.value + '/image_1920' or '/web/static/img/placeholder.png'" 
     class="hms-patient-avatar"/>
                                <div class="hms-patient-info">
                                    <strong><field name="name"/></strong>
                                    <div class="hms-subtitle">
                                        <t t-if="record.is_patient.raw_value">Patient</t>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="hms-patient-details">
                                <div><i class="fa fa-birthday-cake"/> <field name="birthdate"/></div>
                                <div><i class="fa fa-venus-mars"/> <field name="gender"/></div>
                                <div><i class="fa fa-phone"/> <field name="phone"/></div>
                                <div><i class="fa fa-envelope"/> <field name="email"/></div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="hms-patient-actions" groups="hms.group_hms_receptionist,base.group_system">
                                <!-- Create Medical Record -->
                                
                                <button type="object"
                                        name="action_open_medical_wizard"
                                        class="hms-action-btn"
                                        t-if="record.show_create_medical_record.raw_value">
                                    <i class="fa fa-medkit" context="{'new_md': True}"/> Medical Record
                                </button>

                                <!-- Grant Portal -->
                                <button type="object"
                                        name="action_grant_portal_access"
                                        class="hms-action-btn">
                                    <i class="fa fa-unlock"/> Portal
                                </button>

                                <!-- Appointment -->
                                <button type="object"
                                        name="action_schedule_appointment"
                                        class="hms-action-btn">
                                    <i class="fa fa-calendar"/> Appointment
                                </button>

                                <!-- Hospital Visit -->
                                <button type="object"
                                        name="action_start_hospital_visit"
                                        class="hms-action-btn" invisible="not medical_record_id">
                                    <i class="fa fa-hospital-o"/> Visit
                                </button>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

     <!-- Inject custom kanban view -->
    <record id="hms_patient_action_kanban" model="ir.actions.act_window.view">
        <field name="sequence">1</field>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="view_res_partner_kanban_hms"/>
        <field name="act_window_id" ref="hms_patient_action"/>
    </record>

    <!-- Keep original list view -->
    <record id="hms_patient_action_list" model="ir.actions.act_window.view">
        <field name="sequence">2</field>
        <field name="view_mode">list</field>
        <field name="view_id" ref="base.view_partner_tree"/> 
        <field name="act_window_id" ref="hms_patient_action"/>
    </record>

    <!-- Custom form -->
    <record id="hms_patient_action_form" model="ir.actions.act_window.view">
        <field name="sequence">3</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="res_partner_form_hms"/> 
        <field name="act_window_id" ref="hms_patient_action"/>
    </record>


    <!-- Search view for res.partner -->
    <record id="view_res_partner_search_hms" model="ir.ui.view">
        <field name="name">res.partner.search.hms</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <search>
                <!-- Search field section -->
                <field name="name" string="Name" filter_domain="['|', ('name', 'ilike', self), ('email', 'ilike', self)]"/>
                <field name="phone" string="Phone"/>
                <field name="email" string="Email"/>
                <field name="birthdate" string="Birth Date"/>
                <field name="medical_record_id" string="Medical Record ID"/>
                
                <!-- Filter section -->
                <filter string="Patients" name="patients" domain="[('is_patient', '=', True)]"/>
                <filter string="Insurance Companies" name="insurance_companies" domain="[('is_insurance_company', '=', True)]"/>
                <filter string="Without Medical Record" name="without_medical_record" domain="[('medical_record_id', '=', False)]"/>
                <filter string="With Active Cases" name="with_active_cases" domain="[('medical_case_ids.state', 'not in', ['discharged', 'cancelled'])]"/>
                
                <separator/>
                
                <!-- Gender filters -->
                <filter string="Male" name="male" domain="[('gender', '=', 'male')]"/>
                <filter string="Female" name="female" domain="[('gender', '=', 'female')]"/>
                <filter string="Other" name="other_gender" domain="[('gender', '=', 'other')]"/>
                
                <separator/>
                
                <!-- Status filters -->
                <filter string="Active Patients" name="active_patients" domain="[('is_patient', '=', True)]"/>
                <filter string="Portal Users" name="portal_users" domain="[('user_ids', '!=', False)]"/>
                
                <separator/>
                
                <!-- Age-based filters -->
                <filter string="Minors (Under 18)" name="minors" domain="[('birthdate', '!=', False)]" context="{'age_domain': [('age', '&lt;', 18)]}"/>
                <filter string="Adults (18-65)" name="adults" domain="[('birthdate', '!=', False)]" context="{'age_domain': [('age', '&gt;=', 18), ('age', '&lt;=', 65)]}"/>
                <filter string="Seniors (65+)" name="seniors" domain="[('birthdate', '!=', False)]" context="{'age_domain': [('age', '&gt;', 65)]}"/>
                
                <separator/>
                
                <!-- Medical status filters -->
                <filter string="Patients with Emergency Contact" name="with_emergency_contact" domain="[('emergency_contact_id', '!=', False)]"/>
                <filter string="Patients without Emergency Contact" name="without_emergency_contact" domain="[('emergency_contact_id', '=', False)]"/>
                
                <!-- Group By section -->
                <group name="group_by">
                    <filter string="Gender" name="group_by_gender" context="{'group_by': 'gender'}"/>
                    <filter string="Patient Status" name="group_by_patient_status" context="{'group_by': 'is_patient'}"/>
                    <filter string="Insurance Company" name="group_by_insurance" context="{'group_by': 'is_insurance_company'}"/>
                    <filter string="State" name="group_by_state" context="{'group_by': 'state_id'}"/>
                    <filter string="Country" name="group_by_country" context="{'group_by': 'country_id'}"/>
                    <filter string="City" name="group_by_city" context="{'group_by': 'city'}"/>
                    <filter string="Creation Date" name="group_by_creation_date" context="{'group_by': 'create_date:day'}"/>
                    <filter string="Age Group" name="group_by_age" context="{'group_by': 'birthdate'}"/>
                </group>
                
                <!-- Custom search panel/facets -->
                <searchpanel>
                    <field name="gender" icon="fa-venus-mars" string="Gender"  enable_counters="1"/>
                    <field name="state_id" icon="fa-map-marker" string="State"  enable_counters="1"/>
                    <field name="country_id" icon="fa-globe" string="Country"  enable_counters="1"/>

                </searchpanel>
            </search>
        </field>
    </record>

</odoo>
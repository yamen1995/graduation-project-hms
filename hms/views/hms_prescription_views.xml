<odoo>

<record id="view_hms_prescription_form" model="ir.ui.view">
        <field name="name">hms.prescription.form</field>
        <field name="model">hms.prescription</field>
        <field name="arch" type="xml">
            <form string="Prescription">
                <header>
                 <button string="Print Prescription" type="object" name="print_prescription_report" class="btn-primary" groups ="hms.group_hms_chemist,base.group_system,hms.group_hms_doctor,hms.group_hms_nurse"/> 
                    <button string="Confirm" type="object" name="action_confirm" 
                            class="btn-primary" invisible="state != 'draft'" groups ="hms.group_hms_chemist,base.group_system"/>
                    <button string="Dispense" type="object" name="action_dispense" 
                            class="btn-primary" invisible="state != 'confirmed'" groups ="hms.group_hms_chemist,base.group_system"/>
                    <button string="Cancel" type="object" name="action_cancel" class="btn-primary" 
                            invisible="state in ('dispensed', 'cancelled')" groups ="hms.group_hms_chemist,base.group_system,hms.group_hms_doctor"/>
                    <button string="Reset to Draft" type="object" name="action_reset_to_draft" class="btn-primary"
                            invisible="state != 'cancelled'" groups ="hms.group_hms_chemist,base.group_system"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,dispensed"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group>               
                            <field name="case_id" options="{'no_create': True}"
                                readonly="1"
                                groups="hms.group_hms_chemist" />
                            <field name="case_id" options="{'no_create': True}"
                                groups="hms.group_hms_nurse,hms.group_hms_doctor,base.group_system" />
                            <field name="patient_id" readonly="1"/>
                        </group>                                  
                        <group>
                            <field name="date" options="{'no_create': True}"
                                readonly="1"
                                groups="hms.group_hms_chemist" />
                            <field name="date" options="{'no_create': True}"
                                groups="hms.group_hms_nurse,hms.group_hms_doctor,base.group_system" />
                            <field name="is_dispensed" readonly ="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Prescription Lines" name="prescription_lines">
                            <field name="prescription_line_ids">
                                <list editable="bottom" >       
                                    <field name="product_id" domain="[('is_medicine', '=', True)]" />
                                    <field name="uom_id" options="{'no_create': False}"/>
                                    <field name="quantity" sum="Total Quantity"/>
                                    <field name="dosage"/>
                                    <field name="duration"/>
                                </list>
                            </field>
                        </page>
                        <page string="Notes" name="notes">
                            <field name="notes" placeholder="Additional notes or instructions..." context="{ 'default_case_id': case_id, 'default_medical_record_id': medical_record_id }"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- list View -->
    <record id="view_hms_prescription_tree" model="ir.ui.view">
        <field name="name">hms.prescription.tree</field>
        <field name="model">hms.prescription</field>
        <field name="arch" type="xml">
            <list string="Prescriptions" decoration-info="state == 'draft'" 
                  decoration-warning="state == 'confirmed'" decoration-success="state == 'dispensed'"
                  decoration-muted="state == 'cancelled'" sample="1">
                <field name="name"/>
                <field name="case_id"/>
                <field name="patient_id"/>
                <field name="date"/>
                <field name="is_dispensed" widget="boolean_toggle" readonly ="1"/>
                <field name="state" decoration-info="state == 'draft'" 
                       decoration-warning="state == 'confirmed'" 
                       decoration-success="state == 'dispensed'"
                       decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>
        <record id="view_hms_prescription_search" model="ir.ui.view">
        <field name="name">hms.prescription.search</field>
        <field name="model">hms.prescription</field>
        <field name="arch" type="xml">
            <search string="Prescription Search">
                <!-- Search fields for quick search -->
                <field name="name" string="Prescription ID" />
                <field name="patient_id" string="Patient" />
                <field name="case_id" string="Case" />
                <field name="notes" string="Notes" />
                
                
                <separator/>
                
                <!-- State filters -->
                <filter string="Draft Prescriptions" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Confirmed Prescriptions" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="Dispensed Prescriptions" name="dispensed" domain="[('state', '=', 'dispensed')]"/>
                <filter string="Cancelled Prescriptions" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                
                <separator/>
                
                <!-- Dispensing status filters -->
                <filter string="Dispensed" name="dispensed_status" domain="[('is_dispensed', '=', True)]"/>
                <filter string="Not Dispensed" name="not_dispensed" domain="[('is_dispensed', '=', False)]"/>
                
                <separator/>
                
                <!-- Special filters -->
                <filter string="Prescriptions With Notes" name="with_notes" domain="[('notes', '!=', False)]"/>
                <filter string="Prescriptions Without Notes" name="without_notes" domain="[('notes', '=', False)]"/>
                <filter string="Prescriptions With Multiple Medicines" name="multiple_medicines" domain="[('prescription_line_ids', '!=', False)]" context="{'multiple_meds': True}"/>
                
                <!-- Time-based filters -->
                <filter string="Overdue" name="overdue" domain="[('date','&lt;',today()),('state','in',('draft','confirmed'))]"/>
                <filter string="Upcoming" name="upcoming" domain="[('date','&gt;',today())]"/>  
                
                <!-- Group By section -->
                <group name="group_by">
                    <filter string="Status" name="group_by_state" context="{'group_by': 'state'}"/>
                    <filter string="Patient" name="group_by_patient" context="{'group_by': 'patient_id'}"/>
                    <filter string="Case" name="group_by_case" context="{'group_by': 'case_id'}"/>
                    <filter string="Dispensing Status" name="group_by_dispensed" context="{'group_by': 'is_dispensed'}"/>
                    <filter string="Prescription Date" name="group_by_date" context="{'group_by': 'date:day'}"/>
                    <filter string="Prescription Week" name="group_by_week" context="{'group_by': 'date:week'}"/>
                    <filter string="Prescription Month" name="group_by_month" context="{'group_by': 'date:month'}"/>
                </group>
                
                <!-- Search Panel for faceted search -->
                <searchpanel>
                    <field name="state" string="Status" icon="fa-prescription" select="multi" enable_counters="1"/>
                    <field name="patient_id" string="Patient" icon="fa-user" select="multi" enable_counters="1"/>
                    <field name="case_id" string="Case" icon="fa-stethoscope" select="multi" enable_counters="1"/>
                </searchpanel>
            </search>
        </field>
    </record>


<record id="view_hms_prescription_kanban" model="ir.ui.view">
    <field name="name">hms.prescription.kanban</field>
    <field name="model">hms.prescription</field>
    <field name="arch" type="xml">
        <kanban class="hms-partner-kanban" create="true" default_group_by="state">
            <field name="name"/>
            <field name="patient_id"/>
            <field name="case_id"/>
            <field name="date"/>
            <field name="is_dispensed"/>
            <field name="state"/>
            <templates>
                <t t-name="card">
                    <div class="oe_kanban_card hms-kanban-card">

                        <!-- Header with Icon -->
                        <div class="hms-card-header">
                            <div class="hms-pill-icon"/>
                            <div>
                                <div class="hms-title">
                                    <strong><field name="name"/></strong>
                                </div>
                                <div class="hms-subtitle">
                                    Prescription â€¢ <t t-esc="record.date.value"/>
                                </div>
                            </div>
                        </div>

                        <!-- Body -->
                        <div class="hms-card-body">
                            <div>
                                <i class="fa fa-user"/> Patient: <field name="patient_id"/>
                            </div>
                            <div>
                                <i class="fa fa-stethoscope"/> Case: <field name="case_id"/>
                            </div>
                            <div>
                                <i class="fa fa-check-circle"/> Dispensed: 
                                <span t-esc="record.is_dispensed.value and 'Yes' or 'No'"/>
                            </div>
                        </div>

                        <!-- Footer / Status -->
                        <div class="status-indicator">
                            <span t-attf-class="state-badge state-#{record.state.raw_value}">
                                <t t-esc="record.state.value"/>
                            </span>
                        </div>

                        <!-- Action Button -->
                        <div class="btn-print-lp">
                            <button type="object"
                                    name="print_prescription_report"
                                    string="Print"
                                    class="btn btn-sm btn-primary"
                                    icon="fa-print"/>
                        </div>
                    </div>
                </t>
            </templates>
        </kanban>
    </field>
</record>


    <!-- Action to open Prescriptions -->
    <record id="action_prescription" model="ir.actions.act_window">
        <field name="name">Prescription</field>
        <field name="res_model">hms.prescription</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="help" type="html"><p>Manage prescriptions here.</p></field>
    </record>
</odoo>
<odoo>
    <!-- List View -->
    <record id="view_hms_room_list" model="ir.ui.view">
        <field name="name">hms.room.list</field>
        <field name="model">hms.room</field>
        <field name="arch" type="xml">
            <list>
                <field name="name"/>
                <field name="department_id"/>
                <field name="floor"/>
                <field name="capacity"/>
                <field name="is_occupied"/>
                <!-- جديد: نعرض الحالة -->
                <field name="out_of_service"/>
            </list>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_hms_room_form" model="ir.ui.view">
        <field name="name">hms.room.form</field>
        <field name="model">hms.room</field>
        <field name="arch" type="xml">
            <form>
                <!-- جديد: أزرار الهيدر -->
                <header>
                    <!-- يظهر لما الغرفة ليست Out of Service -->
                    <button name="action_mark_out_of_service"
                            type="object"
                            string="Mark Out of Service"
                            class="btn-primary"
                            invisible="out_of_service or not id or can_mark_out_of_service == 0"/>
                    <!-- يظهر لما الغرفة Out of Service -->
                    <button name="action_back_in_service"
                            type="object"
                            string="Back to Service"
                            class="btn-primary"
                            invisible="not out_of_service or not id"/>
                </header>

                <sheet>
                <field name="can_edit" invisible="1"/>
                    <group readonly="can_edit">
                      <group>
                        <field name="name" readonly="1"/>
                        <field name="department_id" readonly="can_edit"/>
                        <field name="floor" readonly="can_edit"/>
                        </group>
                        <group>
                        <field name="beds_total" string="Capacity" readonly="can_edit"/>
                        <field name="is_occupied" readonly="1"/>
                        <field name="out_of_service" invisible="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="view_hms_room_kanban" model="ir.ui.view">
        <field name="name">hms.room.kanban</field>
        <field name="model">hms.room</field>
        <field name="arch" type="xml">
            <kanban default_group_by="number_of_available_beds" class="o_kanban_mobile">
                <field name="name"/>
                <field name="department_id"/>
                <field name="floor"/>
                <field name="capacity"/>
                <field name="is_occupied"/>
                <!-- جديد -->
                <field name="out_of_service"/>
                <field name="beds_total"/>
                <field name="beds_occupied"/>
                <field name="occupancy_rate"/>


                <templates>
                    <t t-name="card">
                        <t t-set="rate" t-value="Math.round(record.occupancy_rate.value || 0)"/>
                        <t t-set="bedsTotal" t-value="record.beds_total.value || 0"/>
                        <t t-set="bedsOcc" t-value="record.beds_occupied.value || 0"/>

                        <div t-attf-class="oe_kanban_global_click o_kanban_record">
                            <div class="o_kanban_record_top" style="display:flex;justify-content:space-between;align-items:center;">
                                <strong class="o_kanban_record_title">
                                    <t t-if="record.department_id.value">
                                    <t t-esc="record.name.value"/>
                                    </t>
 
                                </strong>

                                <!-- إذا الغرفة خارج الخدمة نعرض بادج خاص -->
                                <t t-if="record.out_of_service.raw_value">
                                    <span class="badge bg-secondary">Out of Service</span>
                                </t>
                                <t t-else="">
                                    <span t-att-class="'badge ' + (record.is_occupied.raw_value ? 'bg-danger' : 'bg-success')">
                                        <t t-esc="record.is_occupied.raw_value ? 'Occupied' : 'Available'"/>
                                    </span>
                                </t>
                            </div>

                            <div class="o_kanban_record_body" style="margin-top:6px;">
                                <div>Floor: <t t-esc="record.floor.value or '—'"/></div>
                                <div>Capacity: <t t-esc="record.capacity.value or 0"/></div>
                                <!-- Occupancy line -->
                                <div class="text-muted" style="margin-top:6px;">
                                    Occupancy: <t t-esc="bedsOcc"/>/<t t-esc="bedsTotal"/> (<t t-esc="rate"/>%)
                                </div>
                                <!-- Simple progress bar -->
                                <div style="margin-top:4px;height:6px;background:#eee;border-radius:4px;overflow:hidden;">
                                <div t-att-style="'width:' + rate + '%;height:6px;background:#4caf50;border-radius:4px;'"></div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_hms_room_search" model="ir.ui.view">
        <field name="name">hms.room.search</field>
        <field name="model">hms.room</field>
        <field name="arch" type="xml">
            <search string="Room Search">
                <!-- Search fields for quick search -->
                <field name="name" string="Room Number" filter_domain="[('name', 'ilike', self)]"/>
                <field name="display_name" string="Room Identifier" filter_domain="[('display_name', 'ilike', self)]"/>
                <field name="department_id" string="Department" filter_domain="[('department_id.name', 'ilike', self)]"/>
                <field name="floor" string="Floor"/>
                
                <!-- Predefined filters -->
                <filter string="Available Rooms" name="available_rooms" domain="[('is_occupied', '=', False), ('out_of_service', '=', False)]"/>
                <filter string="Occupied Rooms" name="occupied_rooms" domain="[('is_occupied', '=', True)]"/>
                <filter string="Out of Service" name="out_of_service" domain="[('out_of_service', '=', True)]"/>
                <filter string="In Service" name="in_service" domain="[('out_of_service', '=', False)]"/>
                
                <separator/>
                
                
                <!-- Capacity filters -->
                <filter string="High Capacity (4+ beds)" name="high_capacity" domain="[('capacity', '&gt;=', 4)]"/>
                <filter string="Medium Capacity (2-3 beds)" name="medium_capacity" domain="[('capacity', '&gt;=', 2), ('capacity', '&lt;=', 3)]"/>
                <filter string="Low Capacity (1 bed)" name="low_capacity" domain="[('capacity', '=', 1)]"/>
                
                <separator/>
                
                <!-- Occupancy rate filters -->
                <filter string="Full Occupancy (100%)" name="full_occupancy" domain="[('occupancy_rate', '=', 100)]"/>
                <filter string="High Occupancy (75%+)" name="high_occupancy" domain="[('occupancy_rate', '&gt;=', 75)]"/>
                <filter string="Low Occupancy (25%-)" name="low_occupancy" domain="[('occupancy_rate', '&lt;=', 25)]"/>
                <filter string="Empty Rooms (0%)" name="empty_rooms" domain="[('occupancy_rate', '=', 0)]"/>
                
                <separator/>
                
                <!-- Department-specific filters -->
                <filter string="Emergency Department" name="emergency_rooms" domain="[('department_id.name', 'ilike', 'Emergency')]"/>
                <filter string="ICU Rooms" name="icu_rooms" domain="[('department_id.name', 'ilike', 'ICU')]"/>
                <filter string="Surgery Rooms" name="surgery_rooms" domain="[('department_id.name', 'ilike', 'Surgery')]"/>
                <filter string="Maternity Rooms" name="maternity_rooms" domain="[('department_id.name', 'ilike', 'Maternity')]"/>
                
                <!-- Group By section -->
                <group name="group_by">
                    <filter string="Department" name="group_by_department" context="{'group_by': 'department_id'}"/>                    
                    <filter string="Floor" name="group_by_floor" context="{'group_by': 'floor'}"/>
                    <filter string="Service Status" name="group_by_service" context="{'group_by': 'out_of_service'}"/>
                    <filter string="Occupancy Status" name="group_by_occupancy" context="{'group_by': 'is_occupied'}"/>
                    <filter string="Occupancy Rate Range" name="group_by_occupancy_rate" context="{'group_by': 'occupancy_rate:25'}"/>
                </group>
                
                <!-- Search Panel for faceted search -->
                <searchpanel>
                    <field name="department_id" string="Department" icon="fa-building" select="multi" enable_counters="1"/>
                </searchpanel>
            </search>
        </field>
    </record>

    <!-- Action كما هو عندك -->
    <record id="action_hms_room" model="ir.actions.act_window">
        <field name="name">Rooms</field>
        <field name="res_model">hms.room</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="context">{'search_default_group_by_department_id': 1}</field>
    </record>
</odoo>
